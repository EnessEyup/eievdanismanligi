<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eksik Kira Hesaplayıcısı | Eyüpoğlu & Işıkgör</title>
    <meta name="description" content="Kiracınızdan ne kadar eksik kira alabilirsiniz? Sözleşme tarihinden itibaren yasal maksimum kira artışlarını hesaplayın.">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .calculator {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #4f46e5;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .results {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: none;
        }

        .results h3 {
            color: #4f46e5;
            margin-bottom: 30px;
            font-size: 1.5rem;
            text-align: center;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .summary-card.main {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .summary-card.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .summary-card h4 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .summary-card .amount {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .summary-card.main .amount {
            font-size: 2.2rem;
        }

        .results-table {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

        .results-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .results-table th {
            background: #f9fafb;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .positive {
            color: #059669;
            font-weight: 600;
        }

        .negative {
            color: #dc2626;
            font-weight: 600;
        }

        .tfoot-total {
            background: #f3f4f6;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .export-section {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .calculator,
            .results {
                padding: 25px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-calculator"></i> Eksik Kira Hesaplayıcısı</h1>
            <p>Kiracınızdan ne kadar eksik kira alabilirsiniz? Sözleşme tarihinden itibaren yasal maksimum kira artışlarını hesaplayın.</p>
        </div>

        <!-- Hesaplama Formu -->
        <div class="calculator">
            <!-- Temel Bilgiler -->
            <div class="form-section">
                <h3><i class="fas fa-file-contract"></i> Sözleşme Bilgileri</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="contractDate">Sözleşme Başlangıç Tarihi</label>
                        <input type="date" id="contractDate" required>
                    </div>
                    <div class="form-group">
                        <label for="initialRent">Başlangıç Aylık Kira (₺)</label>
                        <input type="number" id="initialRent" step="0.01" required placeholder="5000">
                    </div>
                    <div class="form-group">
                        <label for="propertyType">Gayrimenkul Türü</label>
                        <select id="propertyType" required>
                            <option value="">Seçiniz</option>
                            <option value="konut">Konut</option>
                            <option value="isyeri">İşyeri</option>
                            <option value="other">Diğer</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="btn" onclick="nextStep()">
                    <i class="fas fa-arrow-right"></i> Devam Et
                </button>
            </div>

            <!-- Yıllık Ödeme Bilgileri -->
            <div id="paymentSection" class="form-section hidden">
                <h3><i class="fas fa-money-bill-wave"></i> Kiracının Ödeme Bilgileri</h3>
                <div id="yearlyPayments">
                    <!-- Dinamik olarak yıllık formlar buraya gelecek -->
                </div>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i> Geri
                    </button>
                    <button type="button" class="btn" onclick="calculateMissingRent()">
                        <i class="fas fa-calculator"></i> Hesapla
                    </button>
                </div>
            </div>
        </div>

        <!-- Sonuçlar -->
        <div class="results" id="results">
            <h3><i class="fas fa-chart-line"></i> Hesaplama Sonuçları</h3>
            
            <div class="summary-cards">
                <div class="summary-card main">
                    <h4>Toplam Eksik Kira</h4>
                    <div class="amount" id="totalMissing">₺0</div>
                    <p>Kiracınızdan talep edebileceğiniz tutar</p>
                </div>
                <div class="summary-card secondary">
                    <h4>Olması Gereken Toplam</h4>
                    <div class="amount" id="totalExpected">₺0</div>
                </div>
                <div class="summary-card secondary">
                    <h4>Ödenen Toplam</h4>
                    <div class="amount" id="totalPaid">₺0</div>
                </div>
            </div>

            <div class="results-table">
                <table>
                    <thead>
                        <tr>
                            <th>Yıl</th>
                            <th>Sözl. Oran</th>
                            <th>Maks. Yasal</th>
                            <th>Beklenen</th>
                            <th>Ödenen</th>
                            <th>Aylık Fark</th>
                            <th>Yıllık Fark</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <!-- Dinamik sonuçlar -->
                    </tbody>
                    <tfoot>
                        <tr class="tfoot-total">
                            <td colspan="6">TOPLAM EKSİK KİRA:</td>
                            <td id="footerTotal" class="positive">₺0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="export-section">
                <button type="button" class="btn" onclick="exportResults()">
                    <i class="fas fa-download"></i> Excel Raporu İndir
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetCalculator()">
                    <i class="fas fa-refresh"></i> Yeni Hesaplama
                </button>
            </div>
        </div>
    </div>

    <script>
        // TÜFE 12 aylık ortalama verileri (gerçek TÜİK verileri)
        const tufeRates = {
            2012: { '01': 9.22, '02': 10.12, '03': 10.45, '04': 10.55, '05': 9.97, '06': 9.35, '07': 8.89, '08': 8.56, '09': 8.29, '10': 8.17, '11': 7.80, '12': 6.99 },
            2013: { '01': 6.51, '02': 6.13, '03': 6.13, '04': 6.15, '05': 6.65, '06': 7.14, '07': 7.48, '08': 7.72, '09': 7.60, '10': 7.59, '11': 7.48, '12': 7.49 },
            2014: { '01': 7.72, '02': 7.77, '03': 8.03, '04': 8.34, '05': 8.76, '06': 8.94, '07': 8.85, '08': 8.99, '09': 8.97, '10': 8.90, '11': 8.81, '12': 8.85 },
            2015: { '01': 8.80, '02': 8.57, '03': 8.24, '04': 7.97, '05': 7.84, '06': 7.89, '07': 7.94, '08': 7.86, '09': 7.86, '10': 7.71, '11': 7.57, '12': 7.67 },
            2016: { '01': 7.86, '02': 8.46, '03': 8.31, '04': 7.78, '05': 7.47, '06': 7.33, '07': 7.59, '08': 7.89, '09': 7.84, '10': 7.77, '11': 7.46, '12': 7.78 },
            2017: { '01': 8.39, '02': 9.18, '03': 10.39, '04': 10.96, '05': 10.90, '06': 10.85, '07': 10.68, '08': 10.75, '09': 11.02, '10': 11.90, '11': 12.98, '12': 11.92 },
            2018: { '01': 10.42, '02': 10.26, '03': 10.23, '04': 10.85, '05': 12.15, '06': 15.39, '07': 15.85, '08': 17.90, '09': 24.52, '10': 25.24, '11': 21.62, '12': 20.30 },
            2019: { '01': 19.67, '02': 19.67, '03': 19.71, '04': 19.50, '05': 18.71, '06': 16.65, '07': 16.86, '08': 15.01, '09': 9.26, '10': 8.55, '11': 10.56, '12': 11.84 },
            2020: { '01': 12.15, '02': 12.37, '03': 11.86, '04': 10.94, '05': 11.39, '06': 11.76, '07': 11.76, '08': 11.77, '09': 11.75, '10': 11.89, '11': 14.03, '12': 14.60 },
            2021: { '01': 14.97, '02': 15.61, '03': 16.19, '04': 17.14, '05': 16.59, '06': 17.53, '07': 18.95, '08': 19.25, '09': 19.58, '10': 19.89, '11': 21.31, '12': 36.08 },
            2022: { '01': 48.69, '02': 54.44, '03': 61.14, '04': 69.97, '05': 73.50, '06': 78.62, '07': 79.60, '08': 80.21, '09': 83.45, '10': 85.51, '11': 84.39, '12': 64.27 },
            2023: { '01': 57.68, '02': 55.18, '03': 50.51, '04': 43.68, '05': 39.59, '06': 38.21, '07': 47.83, '08': 58.94, '09': 61.53, '10': 61.36, '11': 61.98, '12': 64.77 },
            2024: { '01': 57.68, '02': 59.94, '03': 61.98, '04': 62.25, '05': 61.78, '06': 60.56, '07': 58.40, '08': 55.94, '09': 53.91, '10': 51.94, '11': 49.94, '12': 47.57 },
            2025: { '01': 56.35, '02': 53.83, '03': 51.26, '04': 48.73, '05': 45.80, '06': 43.23, '07': 40.00 }
        };

        // ÜFE/Yİ-ÜFE 12 aylık ortalama verileri (gerçek TÜİK verileri)
        const ufeRates = {
            2012: { '01': 12.94, '02': 11.86, '03': 10.52, '04': 9.23, '05': 8.25, '06': 7.03, '07': 5.95, '08': 5.31, '09': 4.44, '10': 3.66, '11': 3.05, '12': 2.45 },
            2013: { '01': 2.17, '02': 2.52, '03': 3.08, '04': 3.27, '05': 3.51, '06': 4.06, '07': 4.68, '08': 5.22, '09': 5.65, '10': 5.94, '11': 5.98, '12': 6.97 },
            2014: { '01': 7.84, '02': 8.57, '03': 8.86, '04': 9.01, '05': 8.95, '06': 8.95, '07': 8.68, '08': 8.51, '09': 8.37, '10': 8.36, '11': 8.61, '12': 6.36 },
            2015: { '01': 4.59, '02': 3.41, '03': 3.11, '04': 3.65, '05': 4.14, '06': 4.26, '07': 4.51, '08': 4.98, '09': 5.34, '10': 5.42, '11': 5.26, '12': 5.71 },
            2016: { '01': 6.29, '02': 6.67, '03': 6.29, '04': 5.68, '05': 5.58, '06': 5.64, '07': 5.64, '08': 5.21, '09': 4.85, '10': 4.52, '11': 4.58, '12': 5.07 },
            2017: { '01': 5.68, '02': 6.59, '03': 7.32, '04': 8.04, '05': 8.80, '06': 9.61, '07': 9.94, '08': 10.51, '09': 11.23, '10': 12.89, '11': 15.68, '12': 15.48 },
            2018: { '01': 13.79, '02': 13.12, '03': 13.57, '04': 14.12, '05': 15.28, '06': 18.54, '07': 21.40, '08': 24.40, '09': 33.28, '10': 46.15, '11': 45.01, '12': 33.64 }
        };

        // Maksimum yasal oran referansı (hesaplama için)
        const inflationRates = {
            2014: 8.85, 2015: 7.67, 2016: 7.78, 2017: 11.92, 2018: 20.30, 2019: 11.84, 2020: 14.60, 2021: 36.08, 2022: 64.27, 2023: 64.77, 2024: 47.57, 2025: 40.00
        };

        let calculationData = [];

        function getRateOptions(year, contractDate, propertyType) {
            const prevYear = year - 1;
            const contractMonth = String(contractDate.getMonth() + 1).padStart(2, '0');
            let options = '';

            // TÜFE (Yasal oran) - Her yıl için mevcut
            if (tufeRates[prevYear] && tufeRates[prevYear][contractMonth]) {
                const rate = tufeRates[prevYear][contractMonth];
                options += `<option value="${rate}|TÜFE (Yasal oran)">TÜFE (Yasal oran) - %${rate.toFixed(2)}</option>`;
            }

            // Yİ-ÜFE (12 aylık ortalama) - 2018'e kadar mevcut
            if (ufeRates[prevYear] && ufeRates[prevYear][contractMonth]) {
                const rate = ufeRates[prevYear][contractMonth];
                options += `<option value="${rate}|Yİ-ÜFE (12 aylık ortalama)">Yİ-ÜFE (12 aylık ortalama) - %${rate.toFixed(2)}</option>`;
            } else {
                // 2019+ için de ÜFE seçeneği olsun (varsayılan değer)
                const defaultUfe = prevYear >= 2019 ? 15 : 10;
                options += `<option value="${defaultUfe}|Yİ-ÜFE (12 aylık ortalama)">Yİ-ÜFE (12 aylık ortalama) - %${defaultUfe.toFixed(2)} (tahmini)</option>`;
            }

            // TÜFE (Geçen yılın aynı ayına göre) - Her yıl için
            if (tufeRates[prevYear] && tufeRates[year-2] && tufeRates[prevYear][contractMonth] && tufeRates[year-2][contractMonth]) {
                const currentRate = tufeRates[prevYear][contractMonth];
                options += `<option value="${currentRate}|TÜFE (Geçen yılın aynı ayına göre)">TÜFE (Geçen yılın aynı ayına göre) - %${currentRate.toFixed(2)}</option>`;
            } else if (tufeRates[prevYear] && tufeRates[prevYear][contractMonth]) {
                const rate = tufeRates[prevYear][contractMonth];
                options += `<option value="${rate}|TÜFE (Geçen yılın aynı ayına göre)">TÜFE (Geçen yılın aynı ayına göre) - %${rate.toFixed(2)}</option>`;
            }

            // Yİ-ÜFE (Geçen yılın aynı ayına göre) - Her yıl için
            if (ufeRates[prevYear] && ufeRates[prevYear][contractMonth]) {
                const rate = ufeRates[prevYear][contractMonth];
                options += `<option value="${rate}|Yİ-ÜFE (Geçen yılın aynı ayına göre)">Yİ-ÜFE (Geçen yılın aynı ayına göre) - %${rate.toFixed(2)}</option>`;
            } else {
                const defaultUfe = prevYear >= 2019 ? 20 : 8;
                options += `<option value="${defaultUfe}|Yİ-ÜFE (Geçen yılın aynı ayına göre)">Yİ-ÜFE (Geçen yılın aynı ayına göre) - %${defaultUfe.toFixed(2)} (tahmini)</option>`;
            }

            // (TÜFE + Yİ-ÜFE)/2 (12 aylık ortalama) - Her yıl için
            if (tufeRates[prevYear] && tufeRates[prevYear][contractMonth]) {
                const tufeRate = tufeRates[prevYear][contractMonth];
                let ufeRate;
                if (ufeRates[prevYear] && ufeRates[prevYear][contractMonth]) {
                    ufeRate = ufeRates[prevYear][contractMonth];
                } else {
                    ufeRate = prevYear >= 2019 ? 15 : 8;
                }
                const avgRate = (tufeRate + ufeRate) / 2;
                options += `<option value="${avgRate}|(TÜFE + Yİ-ÜFE)/2 (12 aylık ortalama)">(TÜFE + Yİ-ÜFE)/2 (12 aylık ortalama) - %${avgRate.toFixed(2)}</option>`;
            }

            // (TÜFE + Yİ-ÜFE)/2 (Geçen yılın aynı ayına göre) - Her yıl için
            if (tufeRates[prevYear] && tufeRates[prevYear][contractMonth]) {
                const tufeRate = tufeRates[prevYear][contractMonth];
                let ufeRate;
                if (ufeRates[prevYear] && ufeRates[prevYear][contractMonth]) {
                    ufeRate = ufeRates[prevYear][contractMonth];
                } else {
                    ufeRate = prevYear >= 2019 ? 20 : 10;
                }
                const avgRate = (tufeRate + ufeRate) / 2;
                options += `<option value="${avgRate}|(TÜFE + Yİ-ÜFE)/2 (Geçen yılın aynı ayına göre)">(TÜFE + Yİ-ÜFE)/2 (Geçen yılın aynı ayına göre) - %${avgRate.toFixed(2)}</option>`;
            }

            // Özel Oran - Her zaman mevcut
            options += '<option value="custom|Özel Oran">Özel Oran</option>';

            return options;
        }

        function nextStep() {
            const contractDate = document.getElementById('contractDate').value;
            const initialRent = parseFloat(document.getElementById('initialRent').value);
            const propertyType = document.getElementById('propertyType').value;

            if (!contractDate || !initialRent || !propertyType) {
                alert('Lütfen tüm alanları doldurun!');
                return;
            }

            generateYearlyForms(new Date(contractDate), initialRent, propertyType);
            document.getElementById('paymentSection').classList.remove('hidden');
        }

        function prevStep() {
            document.getElementById('paymentSection').classList.add('hidden');
        }

        function generateYearlyForms(contractDate, initialRent, propertyType) {
            const container = document.getElementById('yearlyPayments');
            container.innerHTML = '';

            const currentYear = new Date().getFullYear();
            const startYear = contractDate.getFullYear();

            for (let year = startYear; year <= currentYear; year++) {
                if (year === startYear) continue; // İlk yıl artış olmaz

                const yearDiv = document.createElement('div');
                yearDiv.style.cssText = 'background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 15px;';
                
                const rateOptions = getRateOptions(year, contractDate, propertyType);
                const rate = inflationRates[year - 1] || 25;
                const cappedRate = (propertyType === 'konut' && year >= 2022 && year <= 2024) ? Math.min(rate, 25) : rate;

                yearDiv.innerHTML = `
                    <h4 style="color: #374151; margin-bottom: 15px;">${year} Yılı</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Kiracının Bu Yıl Ödediği Aylık Kira (₺)</label>
                            <input type="number" id="paid_${year}" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Sözleşmenizde Yazılan Artış Oranı</label>
                            <select id="rateSelect_${year}" onchange="handleRateSelection(${year})">
                                <option value="">Artış türünü seçin...</option>
                                ${rateOptions}
                            </select>
                            <div id="customRateDiv_${year}" style="display: none; margin-top: 10px;">
                                <input type="number" id="customRate_${year}" step="0.01" min="0" max="100" placeholder="Özel oran girin (%)" required>
                            </div>
                            <div id="rateDiv_${year}" style="display: none; margin-top: 10px;">
                                <input type="number" id="rate_${year}" step="0.01" min="0" max="100" required readonly>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(yearDiv);
            }
        }

        function handleRateSelection(year) {
            const select = document.getElementById(`rateSelect_${year}`);
            const customDiv = document.getElementById(`customRateDiv_${year}`);
            const rateDiv = document.getElementById(`rateDiv_${year}`);
            const rateInput = document.getElementById(`rate_${year}`);
            
            if (select.value.startsWith('custom')) {
                customDiv.style.display = 'block';
                rateDiv.style.display = 'none';
            } else if (select.value !== '') {
                customDiv.style.display = 'none';
                rateDiv.style.display = 'block';
                const rateParts = select.value.split('|');
                const rateValue = parseFloat(rateParts[0]);
                rateInput.value = rateValue.toFixed(2);
            } else {
                customDiv.style.display = 'none';
                rateDiv.style.display = 'none';
            }
        }

        function calculateMissingRent() {
            const contractDate = new Date(document.getElementById('contractDate').value);
            const initialRent = parseFloat(document.getElementById('initialRent').value);
            const propertyType = document.getElementById('propertyType').value;

            calculationData = [];
            let totalMissing = 0;
            let totalExpected = 0;
            let totalPaid = 0;
            let baseRent = initialRent;

            const currentYear = new Date().getFullYear();
            const startYear = contractDate.getFullYear();

            for (let year = startYear; year <= currentYear; year++) {
                if (year === startYear) continue;

                const paidAmount = parseFloat(document.getElementById(`paid_${year}`).value) || 0;
                
                // Oran alma - dropdown seçimine göre
                let contractRate = 0;
                let selectedRateType = '';
                const select = document.getElementById(`rateSelect_${year}`);
                
                if (select.value.startsWith('custom')) {
                    contractRate = parseFloat(document.getElementById(`customRate_${year}`).value) || 0;
                    selectedRateType = 'Özel Oran';
                } else if (select.value !== '') {
                    const rateParts = select.value.split('|');
                    contractRate = parseFloat(rateParts[0]) || 0;
                    selectedRateType = rateParts[1] || 'Bilinmeyen';
                } else {
                    contractRate = parseFloat(document.getElementById(`rate_${year}`).value) || 0;
                    selectedRateType = 'Manuel Giriş';
                }
                
                // O yılki maksimum yasal oran hesapla (bilgi amaçlı)
                const prevYear = year - 1;
                const contractMonth = String(contractDate.getMonth() + 1).padStart(2, '0');
                let maxLegalRate = 0;
                let rateType = '';
                
                if (year <= 2018) {
                    // 2018 ve öncesi ÜFE dönemi
                    if (ufeRates[prevYear] && ufeRates[prevYear][contractMonth]) {
                        maxLegalRate = ufeRates[prevYear][contractMonth];
                        rateType = 'ÜFE';
                    }
                } else {
                    // 2019 ve sonrası TÜFE dönemi
                    if (tufeRates[prevYear] && tufeRates[prevYear][contractMonth]) {
                        const tufeRate = tufeRates[prevYear][contractMonth];
                        
                        // Konut %25 sınırı kontrolü (11 Haziran 2022 - 1 Temmuz 2024)
                        const limitStartDate = new Date('2022-06-11');
                        const limitEndDate = new Date('2024-07-01');
                        const checkDate = new Date(contractDate);
                        checkDate.setFullYear(year);
                        
                        if (propertyType === 'konut' && checkDate >= limitStartDate && checkDate < limitEndDate) {
                            maxLegalRate = Math.min(tufeRate, 25);
                            rateType = maxLegalRate < tufeRate ? '%25 Sınırı' : 'TÜFE';
                        } else {
                            maxLegalRate = tufeRate;
                            rateType = 'TÜFE';
                        }
                    }
                }
                
                if (maxLegalRate === 0) {
                    maxLegalRate = 25;
                    rateType = 'Varsayılan';
                }
                
                const expectedRent = Math.round(baseRent * (1 + contractRate / 100) * 100) / 100;
                const monthlyDiff = Math.max(0, expectedRent - paidAmount);
                const yearlyDiff = monthlyDiff * 12; // Her zaman 12 ay

                totalMissing += yearlyDiff;
                totalExpected += expectedRent * 12;
                totalPaid += paidAmount * 12;

                calculationData.push({
                    year,
                    contractRate,
                    selectedRateType, // Seçilen oran türü (dropdown'dan)
                    maxLegalRate, // O yılki en fazla olabilecek oran
                    rateType, // Maks yasal oran türü (TÜFE/ÜFE/%25 Sınırı)
                    expectedRent,
                    paidAmount,
                    monthlyDiff,
                    yearlyDiff
                });

                baseRent = expectedRent; // Bir sonraki yıl için baz
            }

            displayResults(totalMissing, totalExpected, totalPaid);
        }

        function displayResults(totalMissing, totalExpected, totalPaid) {
            document.getElementById('totalMissing').textContent = formatMoney(totalMissing);
            document.getElementById('totalExpected').textContent = formatMoney(totalExpected);
            document.getElementById('totalPaid').textContent = formatMoney(totalPaid);
            document.getElementById('footerTotal').textContent = formatMoney(totalMissing);

            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            calculationData.forEach(data => {
                const row = tbody.insertRow();
                const diffClass = data.yearlyDiff > 0 ? 'positive' : 'negative';
                
                row.innerHTML = `
                    <td><strong>${data.year}</strong></td>
                    <td>%${data.contractRate.toFixed(2)} <br><small style="color: #6b7280; font-size: 0.75em;">(${data.selectedRateType})</small></td>
                    <td style="color: #6b7280; font-size: 0.9em;">%${data.maxLegalRate.toFixed(2)} <span style="font-size: 0.8em;">(${data.rateType})</span></td>
                    <td><strong>${formatMoney(data.expectedRent)}</strong></td>
                    <td>${formatMoney(data.paidAmount)}</td>
                    <td class="${diffClass}"><strong>${formatMoney(data.monthlyDiff)}</strong></td>
                    <td class="${diffClass}" style="font-size: 1.1em;"><strong>${formatMoney(data.yearlyDiff)}</strong></td>
                `;
            });

            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function exportResults() {
            generateExcel();
        }

        function generateCSV() {
            let csv = 'Yıl,Sözleşme Oranı,Seçilen Tür,Maks. Yasal,Oran Türü,Beklenen,Ödenen,Aylık Fark,Yıllık Fark\n';
            
            calculationData.forEach(data => {
                csv += `${data.year},${data.contractRate.toFixed(2)}%,${data.selectedRateType},${data.maxLegalRate.toFixed(2)}%,${data.rateType},${data.expectedRent.toFixed(2)},${data.paidAmount.toFixed(2)},${data.monthlyDiff.toFixed(2)},${data.yearlyDiff.toFixed(2)}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'eksik-kira-hesaplama.csv';
            link.click();
        }

        function generateExcel() {
            const totalMissing = calculationData.reduce((sum, data) => sum + data.yearlyDiff, 0);
            const totalExpected = calculationData.reduce((sum, data) => sum + (data.expectedRent * 12), 0);
            const totalPaid = calculationData.reduce((sum, data) => sum + (data.paidAmount * 12), 0);
            
            // Excel çalışma kitabı oluştur
            const wb = XLSX.utils.book_new();
            
            // Veri dizisini oluştur
            const wsData = [];
            
            // Başlık bilgileri
            wsData.push(['EKSİK KİRA HESAPLAMA RAPORU']);
            wsData.push(['Rapor Tarihi:', new Date().toLocaleDateString('tr-TR')]);
            wsData.push(['']); // Boş satır
            
            // Özet bilgileri
            wsData.push(['ÖZET BİLGİLER']);
            wsData.push(['Toplam Eksik Kira:', formatMoney(totalMissing)]);
            wsData.push(['Olması Gereken Toplam:', formatMoney(totalExpected)]);
            wsData.push(['Ödenen Toplam:', formatMoney(totalPaid)]);
            wsData.push(['']); // Boş satır
            
            // Tablo başlıkları
            wsData.push([
                'YIL',
                'SÖZLEŞMEDEKİ ORAN (%)',
                'ORAN TÜRÜ',
                'MAKS. YASAL ORAN (%)',
                'YASAL ORAN TÜRÜ',
                'BEKLENEN AYLIK KİRA (₺)',
                'ÖDENEN AYLIK KİRA (₺)',
                'AYLIK FARK (₺)',
                'YILLIK FARK (₺)'
            ]);
            
            // Veri satırları
            calculationData.forEach(data => {
                wsData.push([
                    data.year,
                    data.contractRate.toFixed(2),
                    data.selectedRateType,
                    data.maxLegalRate.toFixed(2),
                    data.rateType,
                    data.expectedRent.toFixed(0),
                    data.paidAmount.toFixed(0),
                    data.monthlyDiff.toFixed(0),
                    data.yearlyDiff.toFixed(0)
                ]);
            });
            
            // Toplam satırı
            wsData.push(['']); // Boş satır
            wsData.push([
                'TOPLAM',
                '', '', '', '',
                '',
                '',
                '',
                totalMissing.toFixed(0)
            ]);
            
            // Çalışma sayfası oluştur
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Sütun genişliklerini ayarla (her şey net görünsün)
            ws['!cols'] = [
                { wch: 8 },  // YIL
                { wch: 18 }, // SÖZLEŞMEDEKİ ORAN
                { wch: 25 }, // ORAN TÜRÜ
                { wch: 18 }, // MAKS. YASAL ORAN
                { wch: 15 }, // YASAL ORAN TÜRÜ
                { wch: 20 }, // BEKLENEN KİRA
                { wch: 18 }, // ÖDENEN KİRA
                { wch: 15 }, // AYLIK FARK
                { wch: 15 }  // YILLIK FARK
            ];
            
            // Hücre stillerini ayarla
            const headerRow = 9; // Tablo başlık satırı
            const dataStartRow = 10; // Veri başlangıç satırı
            
            // Başlık satırı stil
            for (let col = 0; col < 9; col++) {
                const cellRef = XLSX.utils.encode_cell({ r: headerRow, c: col });
                if (!ws[cellRef]) ws[cellRef] = { t: 's', v: '' };
                ws[cellRef].s = {
                    font: { bold: true, color: { rgb: 'FFFFFF' } },
                    fill: { fgColor: { rgb: '4F46E5' } },
                    alignment: { horizontal: 'center', vertical: 'center' },
                    border: {
                        top: { style: 'thin', color: { rgb: '000000' } },
                        bottom: { style: 'thin', color: { rgb: '000000' } },
                        left: { style: 'thin', color: { rgb: '000000' } },
                        right: { style: 'thin', color: { rgb: '000000' } }
                    }
                };
            }
            
            // Veri satırları stil
            for (let row = dataStartRow; row < dataStartRow + calculationData.length; row++) {
                for (let col = 0; col < 9; col++) {
                    const cellRef = XLSX.utils.encode_cell({ r: row, c: col });
                    if (!ws[cellRef]) ws[cellRef] = { t: 's', v: '' };
                    
                    ws[cellRef].s = {
                        font: { size: 11 },
                        alignment: { horizontal: 'center', vertical: 'center' },
                        border: {
                            top: { style: 'thin', color: { rgb: 'CCCCCC' } },
                            bottom: { style: 'thin', color: { rgb: 'CCCCCC' } },
                            left: { style: 'thin', color: { rgb: 'CCCCCC' } },
                            right: { style: 'thin', color: { rgb: 'CCCCCC' } }
                        }
                    };
                    
                    // Zebra çizgiler
                    if ((row - dataStartRow) % 2 === 0) {
                        ws[cellRef].s.fill = { fgColor: { rgb: 'F9FAFB' } };
                    }
                    
                    // Fark sütunları için renklendirme
                    if (col === 7 || col === 8) { // Aylık fark ve yıllık fark
                        const value = parseFloat(wsData[row][col]);
                        if (value > 0) {
                            ws[cellRef].s.font = { color: { rgb: '059669' }, bold: true };
                        } else if (value < 0) {
                            ws[cellRef].s.font = { color: { rgb: 'DC2626' }, bold: true };
                        }
                    }
                }
            }
            
            // Toplam satırı stil
            const totalRow = dataStartRow + calculationData.length + 1;
            for (let col = 0; col < 9; col++) {
                const cellRef = XLSX.utils.encode_cell({ r: totalRow, c: col });
                if (!ws[cellRef]) ws[cellRef] = { t: 's', v: '' };
                ws[cellRef].s = {
                    font: { bold: true, color: { rgb: 'FFFFFF' }, size: 12 },
                    fill: { fgColor: { rgb: '4F46E5' } },
                    alignment: { horizontal: 'center', vertical: 'center' },
                    border: {
                        top: { style: 'thick', color: { rgb: '000000' } },
                        bottom: { style: 'thick', color: { rgb: '000000' } },
                        left: { style: 'thick', color: { rgb: '000000' } },
                        right: { style: 'thick', color: { rgb: '000000' } }
                    }
                };
            }
            
            // Başlık stili
            const titleCellRef = XLSX.utils.encode_cell({ r: 0, c: 0 });
            ws[titleCellRef].s = {
                font: { bold: true, size: 16, color: { rgb: '4F46E5' } },
                alignment: { horizontal: 'center' }
            };
            
            // Özet başlık stili
            const summaryTitleRef = XLSX.utils.encode_cell({ r: 3, c: 0 });
            ws[summaryTitleRef].s = {
                font: { bold: true, size: 12, color: { rgb: '059669' } },
                alignment: { horizontal: 'left' }
            };
            
            // Çalışma kitabına sayfa ekle
            XLSX.utils.book_append_sheet(wb, ws, 'Eksik Kira Raporu');
            
            // Excel dosyasını indir
            XLSX.writeFile(wb, 'eksik-kira-raporu.xlsx');
        }
        
        function formatMoneySimple(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount).replace('₺', '₺');
        }

        function resetCalculator() {
            location.reload();
        }
    </script>
</body>
</html>